"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.storeAccessToken = exports.getAccessTokenAsCookie = exports.getAccessToken = exports.initializeCookies = exports.cookieKey = void 0;
const isNil_1 = __importDefault(require("lodash/isNil"));
const isString_1 = __importDefault(require("lodash/isString"));
const universal_cookie_1 = __importDefault(require("universal-cookie"));
const config_1 = require("../config");
const utils_1 = require("../utils");
function cookieKey() {
    const { wpUrl } = config_1.headlessConfig();
    return `${wpUrl}-at`;
}
exports.cookieKey = cookieKey;
function initializeCookies({ request, cookies, } = {}) {
    if (!isNil_1.default(cookies)) {
        return new universal_cookie_1.default(cookies);
    }
    if (!isNil_1.default(request) && isString_1.default(request.headers.cookie)) {
        return new universal_cookie_1.default(request.headers.cookie);
    }
    return new universal_cookie_1.default();
}
exports.initializeCookies = initializeCookies;
function getAccessToken(options) {
    const cookies = initializeCookies(options);
    const token = cookies.get(cookieKey());
    if (!token) {
        return;
    }
    return utils_1.base64Decode(token);
}
exports.getAccessToken = getAccessToken;
function getAccessTokenAsCookie(options) {
    const COOKIE_KEY = cookieKey();
    const cookies = initializeCookies(options);
    const token = cookies.get(COOKIE_KEY);
    if (!token) {
        return;
    }
    return `${COOKIE_KEY}=${token};`;
}
exports.getAccessTokenAsCookie = getAccessTokenAsCookie;
function storeAccessToken(token, res, options) {
    const COOKIE_KEY = cookieKey();
    const cookies = initializeCookies(options);
    if (!token) {
        cookies.remove(COOKIE_KEY);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        res.setHeader('Set-Cookie', `${COOKIE_KEY}=; expires=${yesterday.toUTCString()}; path=/`);
        return;
    }
    const encodedToken = utils_1.base64Encode(token);
    cookies.set(COOKIE_KEY, encodedToken);
    res.setHeader('Set-Cookie', `${COOKIE_KEY}=${encodedToken}; Max-Age=2592000; path=/; SameSite=Strict; Secure;`);
}
exports.storeAccessToken = storeAccessToken;
